name: ğŸ”„ Claude Code Complete Workflow

on:
  issues:
    types: 
      - opened
  issue_comment:
    types: 
      - created
    
# ä¸¦åˆ—å®Ÿè¡Œã‚’è¨±å¯
concurrency:
  group: claude-dev-${{ github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  complete-workflow:
    # æ¡ä»¶ã‚’ä¿®æ­£ï¼šIssueãŒclaudeãƒ©ãƒ™ãƒ«ä»˜ãã§ä½œæˆã•ã‚ŒãŸå ´åˆã€ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ClaudeãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸå ´åˆ
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-dev')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 10
    
    steps:
      - name: ğŸ” Detect trigger type
        id: trigger
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "trigger=comment" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦å®‰å…¨ã«ä¿å­˜
            COMMENT_BODY=$(echo "${{ github.event.comment.body }}" | base64 -w 0)
            echo "comment_body_base64=${COMMENT_BODY}" >> $GITHUB_OUTPUT
          else
            echo "trigger=issue" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ”€ Generate unique branch name
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RANDOM_ID=$(openssl rand -hex 4)
          ISSUE_NUM=${{ steps.trigger.outputs.issue_number }}
          BRANCH_NAME="claude-dev/issue-${ISSUE_NUM}-${TIMESTAMP}-${RANDOM_ID}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "ğŸŒ³ Branch: ${BRANCH_NAME}"
          
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸŒ³ Create and checkout new branch
        run: |
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-bot@example.com"
          git fetch origin main
          git checkout -b ${{ steps.branch.outputs.branch_name }} origin/main
          
      - name: ğŸ”’ Setup workspace isolation
        run: |
          WORKSPACE_DIR="claude-workspace-${{ steps.trigger.outputs.issue_number }}"
          mkdir -p "${WORKSPACE_DIR}"
          echo "workspace_dir=${WORKSPACE_DIR}" >> $GITHUB_ENV
          
      - name: ğŸ“Š Check for conflicts
        id: conflict-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for potential conflicts..."
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„
          if ACTIVE_PRS=$(gh pr list --state open --label claude-dev --json number,headRefName 2>/dev/null); then
            echo "active_prs=${ACTIVE_PRS}" >> $GITHUB_OUTPUT
          else
            echo "active_prs=[]" >> $GITHUB_OUTPUT
            echo "âš ï¸ Failed to fetch PR list, continuing anyway"
          fi
          
      - name: ğŸ“ Get issue details
        id: issue-details
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.trigger.outputs.issue_number }};
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆã¯ã€Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’å–å¾—
            let instructions = issue.data.body || '';
            if ('${{ steps.trigger.outputs.trigger }}' === 'comment') {
              const commentBase64 = '${{ steps.trigger.outputs.comment_body_base64 }}';
              if (commentBase64) {
                instructions = Buffer.from(commentBase64, 'base64').toString('utf-8');
              }
            }
            
            // å‡ºåŠ›ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
            const sanitizeOutput = (str) => {
              return str ? str.replace(/"/g, '\\"').replace(/\n/g, '\\n') : '';
            };
            
            core.setOutput('title', sanitizeOutput(issue.data.title));
            core.setOutput('body', sanitizeOutput(issue.data.body));
            core.setOutput('instructions', sanitizeOutput(instructions));
            
      - name: ğŸ” Debug API Status
        run: |
          echo "ğŸ” Checking Anthropic API key..."
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "âŒ ANTHROPIC_API_KEY is not set!"
            exit 1
          else
            echo "âœ… ANTHROPIC_API_KEY is set"
          fi
          
      - name: ğŸ¤– Execute Complete Workflow
        id: claude-action
        continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œ
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.branch_name }}
          command: |
            ã‚ãªãŸã¯ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªæ—¥æœ¬èªå¯¾å¿œã®é–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ã™ã¹ã¦ã®å¿œç­”ã¨ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
            
            # ä½œæ¥­æƒ…å ±
            Issueç•ªå·: #${{ steps.trigger.outputs.issue_number }}
            ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.issue-details.outputs.title }}
            ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.trigger.outputs.trigger }}
            ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.branch.outputs.branch_name }}
            
            # æŒ‡ç¤ºå†…å®¹
            ${{ steps.issue-details.outputs.instructions }}
            
            # ä¸¦åˆ—å®Ÿè¡Œã®æ³¨æ„äº‹é …
            - ã“ã®ã‚¿ã‚¹ã‚¯ã¯ä»–ã®ã‚¿ã‚¹ã‚¯ã¨ä¸¦åˆ—ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
            - ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†æ™‚ã¯ç«¶åˆã«æ³¨æ„ã—ã¦ãã ã•ã„
            - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’å„ªå…ˆã—ã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤§å¹…ãªå¤‰æ›´ã¯é¿ã‘ã¦ãã ã•ã„
            
            # ä»¥ä¸‹ã®ãƒ•ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            ## 1. ğŸ“‹ è¦ä»¶å®šç¾©ä½œæˆ
            - Issueã®å†…å®¹ã‚’åˆ†æã—ã¦è¦ä»¶å®šç¾©ã‚’ä½œæˆ
            - `/docs/requirements/issue-${{ steps.trigger.outputs.issue_number }}.md`ã«ä¿å­˜
            - è¦ä»¶å®šç¾©ã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã‚‹ï¼š
              - æ©Ÿèƒ½æ¦‚è¦
              - æŠ€è¡“ä»•æ§˜
              - å®Ÿè£…ã‚¹ã‚³ãƒ¼ãƒ—
              - åˆ¶ç´„äº‹é …
              - ä»–ã®Issueã¨ã®ä¾å­˜é–¢ä¿‚ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            
            ## 2. ğŸ“ CLAUDE.mdä¿®æ­£
            - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®CLAUDE.mdã‚’æ›´æ–°
            - æ–°ã—ã„æ©Ÿèƒ½/ä¿®æ­£å†…å®¹ã‚’è¿½è¨˜
            - Issueç•ªå·ã‚’å‚ç…§ã¨ã—ã¦è¨˜è¼‰
            - ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã«è¿½è¨˜ã™ã‚‹å½¢å¼ã§
            
            ## 3. ğŸ’» ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
            - Issueã®ã€Œé–‹ç™ºå†…å®¹ã®èª¬æ˜ã€ã«åŸºã¥ã„ã¦å®Ÿè£…
            - é–‹ç™ºã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸé©åˆ‡ãªå®Ÿè£…ã‚’è¡Œã†
            - ã‚³ãƒ¼ãƒ‰ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã«å¾“ã†
            - å¯èƒ½ãªé™ã‚Šæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿè£…ã—ã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯æœ€å°é™ã«
            - **é‡è¦**: ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã™ã¹ã¦æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã“ã¨
            
            ## 4. ğŸ§ª å‹•ä½œç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆå®Ÿæ–½
            - å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å®Ÿéš›ã«å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèª
            - ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
            - ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ†ã‚¹ãƒˆï¼š
              - åŸºæœ¬çš„ãªå‹•ä½œãŒæ­£å¸¸ã«è¡Œã‚ã‚Œã‚‹ã‹
              - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã‹
              - æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã‚‹ã‹
              - ä»–ã®æ©Ÿèƒ½ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã„ãªã„ã‹
            - å•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ã‹ã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            
            ## 5. âœ… å®Œäº†è¨˜éŒ²
            - `.claude/completed_tasks.md`ã«ä»¥ä¸‹ã®å½¢å¼ã§è¨˜éŒ²ï¼š
            
            ```markdown
            ## ã‚¿ã‚¹ã‚¯: ${{ steps.issue-details.outputs.title }}
            - Issue: #${{ steps.trigger.outputs.issue_number }}
            - æ—¥æ™‚: $(date +"%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S")
            - ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.branch.outputs.branch_name }}
            - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†
            - ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.trigger.outputs.trigger }}
            - ãƒ•ã‚¡ã‚¤ãƒ«:
              - ä½œæˆ: [ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§]
              - å¤‰æ›´: [ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§]
            - ãƒ†ã‚¹ãƒˆ:
              - å‹•ä½œç¢ºèª: âœ… å®Œäº†
              - ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯: âœ… ãƒ‘ã‚¹
              - ç¢ºèªå†…å®¹: [å®Ÿè¡Œã—ãŸç¢ºèªå†…å®¹]
            - æ¦‚è¦: [å®Ÿè£…å†…å®¹ã®è¦ç´„]
            - ä¸¦åˆ—å®Ÿè¡Œ: ã‚ã‚Š
            ```
            
            ã™ã¹ã¦ã®ä½œæ¥­ã«ãŠã„ã¦æ—¥æœ¬èªã§ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿ƒãŒã‘ã€
            ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
            
      - name: ğŸ” Check Claude Action Result
        if: steps.claude-action.outcome == 'failure'
        run: |
          echo "âŒ Claude Action failed!"
          echo "This might be due to:"
          echo "1. API credit balance is too low"
          echo "2. API key is invalid"
          echo "3. Rate limiting"
          echo ""
          echo "Please check your Anthropic API account and credits."
          
      - name: ğŸ” Post-execution conflict check
        if: steps.claude-action.outcome == 'success'
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor origin/main HEAD; then
            echo "âš ï¸ Main branch has been updated during execution"
            git rebase origin/main || echo "âŒ Conflicts detected, manual resolution required"
          fi
            
      - name: ğŸ“ Create Pull Request
        if: steps.claude-action.outcome == 'success'
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ¤– Complete workflow for issue #${{ steps.trigger.outputs.issue_number }}"
          title: "ğŸ¤– [CLAUDE-DEV] ${{ steps.issue-details.outputs.title }}"
          body: |
            ## ğŸ”„ è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPR
            
            ã“ã®PRã¯Issue #${{ steps.trigger.outputs.issue_number }} ã«åŸºã¥ã„ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            
            ### ğŸŒ³ ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
            - ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ: `${{ steps.branch.outputs.branch_name }}`
            - ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: `main`
            - ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.trigger.outputs.trigger }}
            
            Closes #${{ steps.trigger.outputs.issue_number }}
          branch: ${{ steps.branch.outputs.branch_name }}
          delete-branch: true
          
      - name: ğŸ’¬ Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            const claudeOutcome = '${{ steps.claude-action.outcome }}';
            let message = '';
            
            if (claudeOutcome === 'failure') {
              message = `âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ
              
              ### ã‚¨ãƒ©ãƒ¼æƒ…å ±
              - Anthropic APIã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
              - APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„
              - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
              
              è©³ç´°ã¯Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            } else {
              message = `ğŸ¤– ãƒ•ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼
              
              ### ğŸ“Š å®Ÿè¡Œçµæœ
              - ğŸŒ³ ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ: \`${{ steps.branch.outputs.branch_name }}\`
              - ğŸ”— PR: #${{ steps.cpr.outputs.pull-request-number }}
              - â° å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}
              - ğŸ”„ ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.trigger.outputs.trigger }}
              
              ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼`;
            }
            
            github.rest.issues.createComment({
              issue_number: ${{ steps.trigger.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })